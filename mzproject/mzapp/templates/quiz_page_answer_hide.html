<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Quiz Timer</title>
        {% load static %}
        <link rel="stylesheet" type="text/css" href="{% static 'quiz-page.css' %}" />
        <style>
            a > .answer {
                position: absolute;
                z-index: 0;
            }
            .placeholder {
                width: 100%;
                font-weight: 900;
                font-size: 2rem;
                text-align: center;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
                margin: 5px 0;
                border: 5px solid blue;
                border-radius: 8px;
                box-sizing: border-box;
                position: relative;
                height: 7vh;
                cursor: default;
                opacity: 0;
            }

            .answer-container {
                width: 85%;
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                position: relative; /* 추가 */
            }

            .answer {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                width: 45%;
                margin: 1%;
            }
            .hide {
                display: none;
            }
        </style>
    </head>
    <body>
        <div class="timer-wrapper">
            <div class="timer" id="timer-bar"></div>
            <div class="timer-text" id="timer-text">10.000초</div>
        </div>
        <div class="question">{{ quiz.quiz }}</div>
        <div class="answer-container" id="answer-container">
            <a
                class="answer btn draggable"
                href="{% if next_quiz_id %}{% url 'quiz_page' next_quiz_id %}{% else %}{% url 'result_page' %}{% endif %}"
                data-answer="1"
            >
                <div class="answer-num">A</div>
                {{ quiz.op1 }}
            </a>
            <a
                class="answer btn draggable"
                href="{% if next_quiz_id %}{% url 'quiz_page' next_quiz_id %}{% else %}{% url 'result_page' %}{% endif %}"
                data-answer="2"
            >
                <div class="answer-num">B</div>
                {{ quiz.op2 }}
            </a>
            <a
                class="answer btn draggable"
                href="{% if next_quiz_id %}{% url 'quiz_page' next_quiz_id %}{% else %}{% url 'result_page' %}{% endif %}"
                data-answer="3"
            >
                <div class="answer-num">C</div>
                {{ quiz.op3 }}
            </a>
            <a
                class="answer btn draggable"
                href="{% if next_quiz_id %}{% url 'quiz_page' next_quiz_id %}{% else %}{% url 'result_page' %}{% endif %}"
                data-answer="4"
            >
                <div class="answer-num">D</div>
                {{ quiz.op4 }}
            </a>
            <a
                class="answer btn draggable"
                href="{% if next_quiz_id %}{% url 'quiz_page' next_quiz_id %}{% else %}{% url 'result_page' %}{% endif %}"
                data-answer="5"
            >
                <div class="answer-num">E</div>
                {{ quiz.op5 }}
            </a>
        </div>
        {% if gimic %}
        <p>{{ gimic }}</p>
        {% endif %}
        <script>
            let offsetX, offsetY;
            let initialAbsoluteButton = null;
            {% if quiz.answer == 1 %}
                const correctBtn = document.querySelector('.answer[data-answer="1"]');
            {% elif quiz.answer == 2 %}
                const correctBtn = document.querySelector('.answer[data-answer="2"]');
            {% elif quiz.answer == 3 %}
                const correctBtn = document.querySelector('.answer[data-answer="3"]');
            {% elif quiz.answer == 4 %}
                const correctBtn = document.querySelector('.answer[data-answer="4"]');
            {% elif quiz.answer == 5 %}
                const correctBtn = document.querySelector('.answer[data-answer="5"]');
            {% endif %}
            correctBtn.style.position = "absolute";
            const buttons = document.querySelectorAll(".btn");
            function makeDraggable(element) {
                element.draggable = true;

                element.addEventListener("dragstart", (e) => {
                    offsetX = e.offsetX;
                    offsetY = e.offsetY;
                    e.dataTransfer.setData("text/plain", e.target.id);

                    if (!element.dataset.moved && element !== initialAbsoluteButton) {
                        const placeholder = document.createElement("div");
                        placeholder.className = "placeholder";
                        element.parentNode.insertBefore(placeholder, element.nextSibling);
                        element.dataset.moved = true;
                    }

                    setTimeout(() => {
                        e.target.classList.add("hide");
                    }, 0);
                });

                element.addEventListener("dragend", (e) => {
                    setTimeout(() => {
                        e.target.classList.remove("hide");
                    }, 0);
                });
            }

            document.addEventListener("dragover", (e) => {
                e.preventDefault();
            });

            document.addEventListener("drop", (e) => {
                e.preventDefault();
                const id = e.dataTransfer.getData("text");
                const draggableElement = document.getElementById(id);

                const container = document.getElementById("answer-container");
                const containerRect = container.getBoundingClientRect();
                const elementRect = draggableElement.getBoundingClientRect();

                let left = e.clientX - offsetX;
                let top = e.clientY - offsetY;

                // Ensure the element can move beyond the container
                if (left < containerRect.left - elementRect.width / 2) {
                    left = containerRect.left - elementRect.width / 2;
                } else if (left + elementRect.width / 2 > containerRect.right) {
                    left = containerRect.right - elementRect.width / 2;
                }

                if (top < containerRect.top - elementRect.height / 2) {
                    top = containerRect.top - elementRect.height / 2;
                } else if (top + elementRect.height / 2 > containerRect.bottom) {
                    top = containerRect.bottom - elementRect.height / 2;
                }

                draggableElement.style.position = "absolute";
                draggableElement.style.left = left + "px";
                draggableElement.style.top = top + "px";
                document.body.appendChild(draggableElement);
            });

            buttons.forEach((btn) => {
                makeDraggable(btn);
            });

            let timeLeft = 10000;
            const timerBar = document.getElementById('timer-bar');
            const timerText = document.getElementById('timer-text');
            let nextUrl = "";

            const correctAnswer = {{ quiz.answer }};

            function incrementQCount() {
                let qCount = localStorage.getItem('q_count');
                qCount = qCount ? parseInt(qCount) + 1 : 1;
                localStorage.setItem('q_count', qCount);
            }

            const answers = document.querySelectorAll('.answer');
            answers.forEach(answer => {
                answer.addEventListener('click', function (event) {
                    event.preventDefault();
                    const selectedAnswer = parseInt(this.getAttribute('data-answer'));
                    if (selectedAnswer === correctAnswer) {
                        incrementQCount();
                    }
                    nextUrl = this.href;
                    window.location.href = this.href;
                });
            });

            // const timerInterval = setInterval(() => {
            //     timeLeft -= 10;
            //     const percentageLeft = (timeLeft / 10000) * 100;
            //     timerBar.style.width = percentageLeft + '%';
            //     timerText.textContent = (timeLeft / 1000).toFixed(3) + '초';

            //     if (timeLeft <= 0) {
            //         clearInterval(timerInterval);
            //         timerText.textContent = '0.000초';
            //         alert('타이머 종료!');
            //         window.location.href = nextUrl || document.querySelector('.answer').href;
            //     }
            // }, 10);
        </script>
    </body>
</html>
